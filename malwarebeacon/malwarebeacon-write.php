<?php

/*
 * (C) 2013 Adam Ziaja <adam@adamziaja.com> http://adamziaja.com
 */

$keywords = array('malware');

// https://github.com/abraham/twitteroauth
require_once("twitteroauth/twitteroauth/twitteroauth.php");

// Twitter API
$consumerkey = "XXXXXXXXXX";
$consumersecret = "XXXXXXXXXX";
$accesstoken = "XXXXXXXXXX";
$accesstokensecret = "XXXXXXXXXX";

function getConnectionWithAccessToken($cons_key, $cons_secret, $oauth_token, $oauth_token_secret) {
    $connection = new TwitterOAuth($cons_key, $cons_secret, $oauth_token, $oauth_token_secret);
    return $connection;
}

$connection = getConnectionWithAccessToken($consumerkey, $consumersecret, $accesstoken, $accesstokensecret);

$db = new PDO('mysql:host=localhost;dbname=malwarebeacon;charset=utf8', 'malwarebeacon', 'XXXXXXXXXX');
/*
  CREATE DATABASE malwarebeacon;
  CREATE USER 'malwarebeacon'@'localhost' IDENTIFIED BY 'XXXXXXXXXX';
  GRANT ALL PRIVILEGES ON malwarebeacon.* TO 'malwarebeacon'@'localhost';
  FLUSH PRIVILEGES;
 */
$db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
$db->setAttribute(PDO::ATTR_EMULATE_PREPARES, false);

$query = 'CREATE TABLE IF NOT EXISTS twitter (id_str TEXT NOT NULL, created_at DATETIME NOT NULL, retweet_count SMALLINT, favorite_count SMALLINT, malwarebeacon BOOLEAN)';
$db->exec($query);
echo $query . PHP_EOL;

$query = "SELECT id_str FROM twitter WHERE malwarebeacon != 1 AND (retweet_count >= 10 OR favorite_count >= 10) ORDER BY created_at";
echo $query . PHP_EOL;
foreach ($db->query($query) as $row) {
    $tweet_id = $row['id_str'];
    $status = $connection->post("https://api.twitter.com/1.1/statuses/retweet/$tweet_id.json");
    if (!isset($status->errors) || $status->errors == 'sharing is not permissible for this status (Share validations failed)') {
        $query = "UPDATE twitter SET malwarebeacon = 1 WHERE id_str = '$tweet_id'";
        $db->exec($query);
        echo $query . PHP_EOL;
    } else {
        $error = $status->errors;
        die($error);
    }
}
?>
