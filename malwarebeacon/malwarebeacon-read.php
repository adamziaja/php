<?php

/*
 * (C) 2013 Adam Ziaja <adam@adamziaja.com> http://adamziaja.com
 */

$keywords = array('malware');

// https://github.com/abraham/twitteroauth
require_once("twitteroauth/twitteroauth/twitteroauth.php");

// Twitter API
$consumerkey = "XXXXXXXXXX";
$consumersecret = "XXXXXXXXXX";
$accesstoken = "XXXXXXXXXX";
$accesstokensecret = "XXXXXXXXXX";

function getConnectionWithAccessToken($cons_key, $cons_secret, $oauth_token, $oauth_token_secret) {
    $connection = new TwitterOAuth($cons_key, $cons_secret, $oauth_token, $oauth_token_secret);
    return $connection;
}

$connection = getConnectionWithAccessToken($consumerkey, $consumersecret, $accesstoken, $accesstokensecret);

$db = new PDO('mysql:host=localhost;dbname=malwarebeacon;charset=utf8', 'malwarebeacon', 'XXXXXXXXXX');
/*
  CREATE DATABASE malwarebeacon;
  CREATE USER 'malwarebeacon'@'localhost' IDENTIFIED BY 'XXXXXXXXXX';
  GRANT ALL PRIVILEGES ON malwarebeacon.* TO 'malwarebeacon'@'localhost';
  FLUSH PRIVILEGES;
 */
$db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); // http://wiki.hashphp.org/PDO_Tutorial_for_MySQL_Developers
$db->setAttribute(PDO::ATTR_EMULATE_PREPARES, false);

$query = 'CREATE TABLE IF NOT EXISTS twitter (id_str TEXT NOT NULL, created_at DATETIME NOT NULL, retweet_count SMALLINT, favorite_count SMALLINT, malwarebeacon BOOLEAN)';
$db->exec($query);
echo $query . PHP_EOL;

foreach ($keywords as $keyword) {
    $tweets = $connection->get("https://api.twitter.com/1.1/search/tweets.json?q=$keyword&count=100");
    if (!isset($tweets->errors)) {
        foreach ($tweets->statuses as $tweet) {
            if (isset($tweet->retweeted_status)) {
                $tweet_id = $tweet->retweeted_status->id_str;
                $tweet_created = date('Y-m-d H:i:s', strtotime($tweet->retweeted_status->created_at));
            } else {
                $tweet_id = $tweet->id_str;
                $tweet_created = date('Y-m-d H:i:s', strtotime($tweet->created_at));
            }
            $tweet_retweet = $tweet->retweet_count;
            $tweet_favorite = $tweet->favorite_count;

            $query = "SELECT COUNT(*) FROM twitter WHERE id_str = '$tweet_id'";
            echo $query . PHP_EOL;
            foreach ($db->query($query) as $row) {
                $count = $row['COUNT(*)'];
            }
            if ($count == 0) {
                $query = "INSERT INTO twitter (id_str, created_at, retweet_count, favorite_count, malwarebeacon) VALUES ('$tweet_id', '$tweet_created', '$tweet_retweet', '$tweet_favorite', 0)";
                $db->exec($query);
                echo $query . PHP_EOL;
            } else {
                $query = "UPDATE twitter SET retweet_count = '$tweet_retweet', favorite_count = '$tweet_favorite' WHERE id_str = '$tweet_id'";
                $db->exec($query);
                echo $query . PHP_EOL;
            }
        }
    } else {
        $error = $tweets->errors;
        die($error);
    }
}
?>